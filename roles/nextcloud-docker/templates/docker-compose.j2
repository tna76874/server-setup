version: '3.3'

services:
  db:
    image: mariadb:{{ tag_mariadb }}
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./data/db:/var/lib/mysql
    env_file:
      - ./.env

  redis:
    image: redis:{{ tag_redis }}
    restart: always
    volumes:
      - ./data/redis:/var/lib/redis

  app:
    image: nextcloud:{{ tag_nextcloud }}
    restart: always
    depends_on:
      - db
      - redis
    volumes:
      - ./data/nextcloud:/var/www/html
      - ./data/nextcloud/data:/var/www/html/data
    env_file:
      - ./.env
    environment:
{% for envs in compose_config_env %}
      - {{ envs.var }}={{ envs.val }}
{% endfor %}

  web:
    image: nginx:{{ tag_nginx }}
    restart: always
    ports:
      - 127.0.0.1:{{ compose_config_tcp_port }}:80
    volumes:
      - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/nginx/uploadsize.conf:/etc/nginx/conf.d/uploadsize.conf:ro
    volumes_from:
      - app

{% if enable_calbackup|bool %}
  nextcloud-nc-backup:
    image: waja/calcardbackup:{{ tag_calbackup }}
    links:
      - db:nextcloud-db
      - web:nextcloud
    environment:
      - CRON_TIME=5 4 * * *
      - INIT_BACKUP=yes
      - CALCARD_OPTS=-i -r 20
      - NC_DIR=/nextcloud
      - NC_HOST={{ nginx_domain_name }}
      - NC_PORT=80
      - DB_HOST=db
    depends_on:
      - db
      - web
    restart: unless-stopped
    volumes:
      - ./data/calbackup:/backup
      - ./data/nextcloud/config:/nextcloud/config:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
{% endif %}